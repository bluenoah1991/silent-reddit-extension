# 实现记录 - T14

## 任务信息
- **编号**: T14
- **描述**: 更新 manifest.json：按依赖顺序添加所有拆分后的 js 文件到 content_scripts

## 实现细节

### 更新的 content_scripts 配置
```json
"content_scripts": [
  {
    "matches": [
      "*://*.reddit.com/*"
    ],
    "css": [
      "styles.css"
    ],
    "js": [
      "constants.js",
      "settings-manager.js",
      "ads-blocker.js",
      "media-blocker.js",
      "banner-blocker.js",
      "logo-replacer.js",
      "icons-replacer.js",
      "coordinator.js",
      "mutation-observer.js",
      "content.js"
    ],
    "run_at": "document_start"
  }
]
```

### 加载顺序说明

#### 阶段1: 基础设施（无依赖）
1. **constants.js** - 定义全局常量和命名空间
   - 创建 `SilentReddit` 命名空间
   - 定义所有常量

2. **settings-manager.js** - 设置管理类
   - 依赖 constants.js 中的 DEFAULT_SETTINGS
   - 提供设置加载和监听功能

#### 阶段2: 功能模块（依赖基础设施）
3. **ads-blocker.js** - 广告屏蔽
   - 依赖 SELECTORS.ADS
   
4. **media-blocker.js** - 媒体屏蔽
   - 依赖 SELECTORS, DATA_ATTRS, CSS_CLASSES
   
5. **banner-blocker.js** - Banner 屏蔽
   - 依赖 SELECTORS, DATA_ATTRS
   
6. **logo-replacer.js** - Logo 替换
   - 依赖 SELECTORS, DATA_ATTRS
   
7. **icons-replacer.js** - 图标替换
   - 依赖 SELECTORS, DATA_ATTRS, AVATAR_COLORS, CSS_CLASSES

#### 阶段3: 协调层（依赖功能模块）
8. **coordinator.js** - 协调器
   - 依赖所有功能模块
   - 依赖 SettingsManager

9. **mutation-observer.js** - DOM 观察器
   - 依赖 coordinator
   - 依赖 adsBlocker
   - 依赖 SettingsManager

#### 阶段4: 入口文件（依赖所有模块）
10. **content.js** - 主入口
    - 依赖所有前述模块
    - 执行初始化流程

### 依赖关系图
```
constants.js
    ↓
settings-manager.js
    ↓
ads-blocker.js, media-blocker.js, banner-blocker.js, logo-replacer.js, icons-replacer.js
    ↓
coordinator.js
    ↓
mutation-observer.js
    ↓
content.js
```

### 加载顺序验证
Chrome Extension 保证按数组顺序同步加载脚本：
1. 顺序加载，前一个加载完才加载下一个
2. 所有脚本共享全局作用域（SilentReddit 命名空间）
3. content.js 执行时所有依赖已就绪

### 与 D02 讨论的对比
D02 讨论中提出的加载顺序：
```
constants.js → settings-manager.js → ads-blocker.js → media-blocker.js 
→ banner-blocker.js → logo-replacer.js → icons-replacer.js 
→ coordinator.js → mutation-observer.js → content.js
```

**实际顺序完全一致** ✅

### run_at 配置
```json
"run_at": "document_start"
```

**说明：**
- 尽可能早地执行脚本
- 在 document.body 创建前就开始运行
- content.js 中已处理 body 不存在的情况

### 测试验证
构建输出确认所有文件已拷贝：
```
Copied: constants.js
Copied: settings-manager.js
Copied: ads-blocker.js
Copied: media-blocker.js
Copied: banner-blocker.js
Copied: logo-replacer.js
Copied: icons-replacer.js
Copied: coordinator.js
Copied: mutation-observer.js
Copied: content.js
```

### 其他 manifest.json 内容保持不变
- name, version, description
- icons
- action (popup)
- permissions (storage)
- web_accessible_resources (*.svg)

---
*创建时间: 2025-10-18*
