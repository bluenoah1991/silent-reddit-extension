# 实现记录 - T11

## 任务信息
- **编号**: T11
- **描述**: 创建 coordinator.js 模块：实现统一的协调器管理所有模块的 hide/show 调用

## 实现细节

### 模块设计
创建了 `SilentReddit.coordinator` 对象，作为所有屏蔽模块的统一协调器。

### 核心属性
```javascript
settingsManager: null  // Settings manager 引用
```

### 核心方法

#### 1. init(settingsManager)
初始化协调器：
```javascript
init(settingsManager) {
    this.settingsManager = settingsManager;
}
```

**特点：**
- 依赖注入方式接收 SettingsManager 实例
- 解耦协调器和设置管理

#### 2. applyOrRemove()
根据当前设置应用或移除所有屏蔽规则：
```javascript
applyOrRemove() {
    const settings = this.settingsManager.get();

    if (!settings.enabled) {
        this.removeAll();
        SilentReddit.logoReplacer.restoreAll();
        SilentReddit.iconsReplacer.stopPeriodicCheck();
        return;
    }

    // Apply blocking based on individual settings
    if (settings.blockAds) {
        SilentReddit.adsBlocker.hideAll();
    } else {
        SilentReddit.adsBlocker.showAll();
    }

    if (settings.blockMedia) {
        SilentReddit.mediaBlocker.hideAll();
        SilentReddit.iconsReplacer.hideAll();
        SilentReddit.bannerBlocker.hideAll();
        SilentReddit.iconsReplacer.startPeriodicCheck();
    } else {
        SilentReddit.mediaBlocker.showAll();
        SilentReddit.iconsReplacer.showAll();
        SilentReddit.bannerBlocker.showAll();
        SilentReddit.iconsReplacer.stopPeriodicCheck();
    }

    // Logo replacement is independent of enabled state
    if (settings.replaceLogo) {
        SilentReddit.logoReplacer.replaceAll();
    } else {
        SilentReddit.logoReplacer.restoreAll();
    }
}
```

**特点：**
- 根据 `enabled` 状态决定是否启用屏蔽
- 根据各个开关（blockAds, blockMedia, replaceLogo）控制具体功能
- 图标替换和 banner 屏蔽跟随 blockMedia 设置
- Logo 替换独立于 enabled 设置（符合 D01 讨论）
- 管理图标定时器的启停

#### 3. removeAll()
移除所有屏蔽（显示所有内容）：
```javascript
removeAll() {
    SilentReddit.adsBlocker.showAll();
    SilentReddit.mediaBlocker.showAll();
    SilentReddit.iconsReplacer.showAll();
    SilentReddit.bannerBlocker.showAll();
}
```

**特点：**
- 调用所有模块的 showAll 方法
- 不处理 Logo（由 applyOrRemove 单独处理）

#### 4. applyToNode(targetNode)
对特定节点应用屏蔽规则（用于动态内容）：
```javascript
applyToNode(targetNode) {
    const settings = this.settingsManager.get();

    if (!settings.enabled || !targetNode || !targetNode.querySelectorAll) {
        return;
    }

    // Apply blocking to new node
    if (settings.blockAds) {
        SilentReddit.adsBlocker.hideAll(targetNode);
    }

    if (settings.blockMedia) {
        SilentReddit.mediaBlocker.hideAll(targetNode);
        SilentReddit.iconsReplacer.hideAll(targetNode);
        SilentReddit.bannerBlocker.hideAll(targetNode);
    }
}
```

**特点：**
- 专为 MutationObserver 回调设计
- 只处理需要 targetNode 的模块
- 不处理 Logo（Logo 是全局单例，不需要节点参数）

### 协调策略

#### 模块调用顺序
1. **广告屏蔽** - 独立开关
2. **媒体屏蔽** - 控制三个子模块：
   - mediaBlocker
   - iconsReplacer
   - bannerBlocker
3. **Logo 替换** - 独立开关，不受 enabled 影响

#### 定时器管理
- blockMedia 开启时启动图标定时器
- blockMedia 关闭或 enabled 关闭时停止定时器

### 设计原则
- ✅ **单一职责**：只负责协调各模块，不包含业务逻辑
- ✅ **命令式调用**：显式调用每个模块的 hide/show 方法（符合 D01 讨论）
- ✅ **依赖注入**：通过 init 方法接收依赖
- ✅ **统一接口**：所有模块遵循 hideAll/showAll 接口规范

### 日志
模块加载时输出：`[SR] Coordinator module loaded`

---
*创建时间: 2025-10-18*
