# 实现记录 - T03

## 任务信息
- **编号**: T03
- **描述**: 创建 settings-manager.js 模块：实现 SettingsManager 类管理设置加载和监听

## 实现细节

### 类设计
创建了 `SettingsManager` 类，作为 `SilentReddit` 命名空间的属性。

### 核心功能

#### 1. 构造函数
```javascript
constructor() {
    this.settings = { ...SilentReddit.DEFAULT_SETTINGS };
    this.changeCallbacks = [];
}
```
- 初始化设置为默认值
- 维护回调函数数组用于通知设置变更

#### 2. load() 方法
异步加载设置：
```javascript
async load() {
    try {
        this.settings = await chrome.storage.sync.get(SilentReddit.DEFAULT_SETTINGS);
        console.log('[SR] Settings loaded:', this.settings);
    } catch (error) {
        console.error('[SR] Failed to load settings:', error);
        this.settings = { ...SilentReddit.DEFAULT_SETTINGS };
    }
}
```
- 使用 try-catch 包裹异步操作（符合 D05 错误处理策略）
- 加载失败时回退到默认设置
- 记录关键日志

#### 3. get() 方法
获取当前设置：
```javascript
get() {
    return this.settings;
}
```

#### 4. onChange() 方法
注册设置变更回调：
```javascript
onChange(callback) {
    this.changeCallbacks.push(callback);
}
```

#### 5. startListening() 方法
监听 Chrome storage 变化：
```javascript
startListening() {
    chrome.storage.onChanged.addListener((changes, areaName) => {
        if (areaName !== 'sync') return;

        let updated = false;
        const changedSettings = {};

        ['enabled', 'blockAds', 'blockMedia', 'replaceLogo'].forEach(key => {
            if (changes[key]) {
                this.settings[key] = changes[key].newValue;
                changedSettings[key] = changes[key].newValue;
                updated = true;
            }
        });

        if (updated) {
            console.log('[SR] Settings updated:', this.settings);
            // Notify all registered callbacks
            this.changeCallbacks.forEach(callback => {
                try {
                    callback(this.settings, changedSettings);
                } catch (error) {
                    console.error('[SR] Error in settings change callback:', error);
                }
            });
        }
    });
}
```
- 监听所有支持的设置项
- 通知所有注册的回调函数
- 回调执行使用 try-catch 包裹，防止单个回调失败影响其他回调

### 错误处理
- 遵循 D05 错误处理策略：只在 Chrome API 异步操作处使用 try-catch
- 采用静默失败 + 日志记录策略

### 日志
- 使用 `[SR]` 前缀（符合 D05 日志策略）
- 记录关键信息：设置加载、设置更新、错误

---
*创建时间: 2025-10-18*
