# 实现记录 - T08, T09, T10

## 任务信息
- **编号**: T08, T09, T10
- **描述**: 创建 icons-replacer.js 模块，实现 Letter Avatar 生成、社区图标替换和用户头像替换功能

## 实现细节

### 模块概述
创建了完整的 `SilentReddit.iconsReplacer` 对象，包含三部分功能：
1. **T08**: Letter Avatar 生成和颜色计算
2. **T09**: 社区图标替换（包括 Shadow DOM 处理）
3. **T10**: 用户头像替换和定时器管理

---

## T08: Letter Avatar 生成逻辑

### 1. 颜色生成 - _getColorFromName(name)
```javascript
_getColorFromName(name) {
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
        hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return SilentReddit.AVATAR_COLORS[Math.abs(hash) % SilentReddit.AVATAR_COLORS.length];
}
```

**特点：**
- 使用简单的哈希算法保证同名用户颜色一致
- 从 10 色调色板中选择颜色

### 2. DOM Letter Avatar - _createLetterAvatar(name)
创建 DOM 元素形式的字母头像：
```javascript
_createLetterAvatar(name) {
    if (!name) return null;

    const letter = name.charAt(0).toUpperCase();
    const color = this._getColorFromName(name);

    const avatar = document.createElement('div');
    avatar.className = SilentReddit.CSS_CLASSES.LETTER_AVATAR;
    avatar.textContent = letter;
    avatar.style.cssText = `
        width: 100%;
        height: 100%;
        border-radius: 50%;
        background-color: ${color};
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: inherit;
        margin: 0 !important;
        padding: 0 !important;
    `;

    return avatar;
}
```

**用途：** 替换需要隐藏原元素的场景（如用户头像）

### 3. SVG Data URL - _createLetterAvatarDataURL(name)
创建 SVG 格式的 Base64 Data URL：
```javascript
_createLetterAvatarDataURL(name) {
    if (!name) return null;

    const letter = name.charAt(0).toUpperCase();
    const color = this._getColorFromName(name);

    const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 64 64">
        <circle cx="32" cy="32" r="32" fill="${color}"/>
        <text x="50%" y="50%" text-anchor="middle" dy=".35em" fill="white" font-size="32" font-weight="bold" font-family="Arial, sans-serif">${letter}</text>
    </svg>`;

    return 'data:image/svg+xml;base64,' + btoa(svg);
}
```

**用途：** 直接替换 img 元素的 src（如 Shadow DOM 中的图标）

---

## T09: 社区图标替换（包括 Shadow DOM）

### 1. 名称提取辅助方法

#### _getSubredditNameFromIcon(icon)
从图标元素提取社区名称：
- 从父链接的 href 中提取（`/r/{name}`）
- 从 alt 文本中提取

#### _extractCommunityName(element, prefixedName)
通用社区名称提取：
- 优先使用 prefixedName 属性
- 从父链接 href 中提取

### 2. 帖子社区图标替换 - _replacePostSubredditIcons(targetNode)
```javascript
_replacePostSubredditIcons(targetNode) {
    const selector = SilentReddit.SELECTORS.SUBREDDIT_ICON + ':not([' + SilentReddit.DATA_ATTRS.ICON_REPLACED + '])';
    targetNode.querySelectorAll(selector).forEach(icon => {
        const subredditName = this._getSubredditNameFromIcon(icon);
        if (!subredditName) return;

        const letterAvatar = this._createLetterAvatar(subredditName);
        if (!letterAvatar) return;

        icon.setAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED, 'true');
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC, icon.src);
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE, icon.style.cssText);
        icon.style.setProperty('display', 'none', 'important');
        icon.parentNode?.insertBefore(letterAvatar, icon);
    });
}
```

**特点：**
- 隐藏原图标，插入 DOM 字母头像
- 保存原始 src 和 style

### 3. Shadow DOM 处理

#### _replaceNavCommunitiesIcons()
处理左侧导航栏社区图标（Shadow DOM）：
```javascript
_replaceNavCommunitiesIcons() {
    const controller = document.querySelector(SilentReddit.SELECTORS.NAV_COMMUNITIES_CONTROLLER);
    if (!controller?.shadowRoot) return;

    const items = controller.shadowRoot.querySelectorAll(SilentReddit.SELECTORS.NAV_COMMUNITY_ITEM);
    items.forEach(item => {
        if (!item.shadowRoot) return;

        const prefixedName = item.getAttribute('prefixedname');
        const selector = 'img:not([' + SilentReddit.DATA_ATTRS.ICON_REPLACED + '])';
        const imgs = item.shadowRoot.querySelectorAll(selector);

        imgs.forEach(img => {
            const communityName = this._extractCommunityName(img, prefixedName);
            if (communityName && !img.getAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC)) {
                img.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC, img.src);
                img.src = this._createLetterAvatarDataURL(communityName);
                img.srcset = '';
                img.setAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED, 'true');
            }
        });
    });
}
```

**特点：**
- 穿透 Shadow DOM 边界
- 直接替换 img 的 src 为 Data URL（无法插入自定义元素）
- 清空 srcset 防止加载其他图片

#### _replaceRecentPagesIcons()
处理最近访问页面图标（Shadow DOM）：
- 检测社区图标（URL 包含 communityIcon 或 redditmedia）
- 替换 src 为字母头像 Data URL

---

## T10: 用户头像替换和定时器管理

### 1. 用户名提取 - _getUsernameFromAvatar(avatar)
```javascript
_getUsernameFromAvatar(avatar) {
    // Try to find username from nearby link
    const link = avatar.closest('a[href*="/user/"]');
    if (link) {
        const match = link.href.match(/\/user\/([^/?]+)/);
        if (match) return match[1];
    }

    // Try to find from alt text
    const img = avatar.querySelector ? avatar.querySelector('img, image') : ...;
    if (img) {
        const alt = img.alt || img.getAttribute('alt') || '';
        const altMatch = alt.match(/u\/([^\s]+)/);
        if (altMatch) return altMatch[1];
    }

    return null;
}
```

### 2. 用户头像替换

#### _replaceUserAvatarImages(targetNode)
替换普通 img 头像：
- 查询 `[slot="commentAvatar"] img` 和 `a[href*="/user/"] img`
- 隐藏原图片，插入字母头像
- 跳过社区图标

#### _replaceSnoovatarAvatars(targetNode)
替换 SVG snoovatar 头像：
- 查询 `.snoovatar` 元素
- 隐藏原 snoovatar，插入字母头像

#### _replaceAvatarContainers(targetNode)
处理复杂头像容器：
- 查询 `[slot="commentAvatar"] [rpl][avatar]`
- 找到内部 snoovatar 或 img 元素隐藏
- 向容器添加字母头像

### 3. 定时器管理

#### startPeriodicCheck()
启动 Shadow DOM 定时检查：
```javascript
startPeriodicCheck() {
    this.stopPeriodicCheck();

    const checkShadowDOM = () => {
        try {
            this._replaceNavCommunitiesIcons();
            this._replaceRecentPagesIcons();
        } catch (error) {
            console.error('[SR] Error in Shadow DOM check:', error);
        }
    };

    // First check after 2 seconds, then every 3 seconds
    this._timeoutId = setTimeout(checkShadowDOM, 2000);
    this._intervalId = setInterval(checkShadowDOM, 3000);
}
```

**策略：**
- 首次检查延迟 2 秒（等待 Shadow DOM 加载）
- 后续每 3 秒检查一次
- 使用 try-catch 包裹防止错误中断定时器（符合 D05 策略）

#### stopPeriodicCheck()
停止定时检查：
- 清除 timeout 和 interval
- 将 ID 设置为 null

---

## 公共接口

### hideAll(targetNode = document)
隐藏所有图标并替换为字母头像：
- 替换帖子社区图标
- 替换用户头像（三种类型）
- 替换 Shadow DOM 图标（仅全页面时）

### showAll()
显示所有原始图标：
- 恢复帖子社区图标
- 恢复用户头像
- 恢复 Shadow DOM 图标
- 删除所有字母头像元素

### startPeriodicCheck() / stopPeriodicCheck()
管理 Shadow DOM 定时检查

---

## 设计决策

### 符合讨论决策
- ✅ **D01**: 保持定时器轮询策略（3秒间隔）
- ✅ **D03**: 使用 `data-sr-icon-replaced` 标记，保存原始数据到 `data-sr-original-*`
- ✅ **D05**: 错误处理使用 try-catch + 静默失败 + 日志
- ✅ **D06**: 不采用复杂的 MutationObserver 优化，保持简单可靠

### 幂等性保证
- 通过 `data-sr-icon-replaced` 属性避免重复处理
- Shadow DOM 中通过选择器 `:not([data-sr-icon-replaced])` 过滤

### 两种替换策略
1. **DOM 元素替换**：用于可以操作父节点的场景
2. **Data URL 替换**：用于 Shadow DOM 中无法插入自定义元素的场景

### 日志
模块加载时输出：`[SR] Icons replacer module loaded`

---
*创建时间: 2025-10-18*
