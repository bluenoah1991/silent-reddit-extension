# 实现记录 - T15

## 任务信息
- **编号**: T15
- **描述**: 更新 build.js：修改自动扫描逻辑，将所有新模块文件拷贝到 out/ 目录

## 实现细节

### 变更总结
T15 的工作实际在 T01 中已完成，本任务无需额外工作。

### T01 中完成的更新

#### 1. 新增 getJsFiles() 函数
```javascript
function getJsFiles() {
    const jsFiles = fs.readdirSync(SOURCE_DIR)
        .filter(file => file.endsWith('.js') && file !== 'build.js' && !file.endsWith('.backup'));
    return jsFiles;
}
```

**功能：**
- 扫描根目录下所有 .js 文件
- 排除 build.js 本身
- 排除 .backup 文件
- 返回文件名数组

#### 2. 更新 build() 函数
```javascript
function build() {
    console.log('Building Silent Reddit extension...\n');
    ensureDir(OUTPUT_DIR);

    let successCount = 0;
    let failCount = 0;

    const jsFiles = getJsFiles();
    const allItems = [...FILES_TO_COPY, ...jsFiles, ...DIRS_TO_COPY];

    allItems.forEach(item => {
        const fn = DIRS_TO_COPY.includes(item) ? copyDir : copyFile;
        fn(item) ? successCount++ : failCount++;
    });

    console.log(`\nBuild complete: ${successCount} items copied`);
    if (failCount > 0) console.warn(`${failCount} items failed`);
    console.log(`Output directory: ${OUTPUT_DIR}`);
}
```

**变更：**
- 使用 `getJsFiles()` 动态获取 JS 文件列表
- 合并到 allItems 数组
- 自动拷贝所有扫描到的 JS 文件

#### 3. 更新 watch() 函数
```javascript
function watch() {
    console.log('Starting watch mode...\n');
    build();
    console.log('\nWatching for file changes...\nPress Ctrl+C to stop\n');

    const jsFiles = getJsFiles();
    const filesToWatch = [...FILES_TO_COPY, ...jsFiles];

    filesToWatch.forEach(fileName => {
        const filePath = path.join(SOURCE_DIR, fileName);
        if (fs.existsSync(filePath)) {
            fs.watch(filePath, (eventType) => {
                if (eventType === 'change') {
                    console.log(`\nFile changed: ${fileName}`);
                    copyFile(fileName);
                }
            });
        }
    });

    // ... DIRS_TO_COPY watch code
}
```

**变更：**
- 使用 `getJsFiles()` 获取 JS 文件列表
- 监听所有扫描到的 JS 文件

#### 4. FILES_TO_COPY 更新
```javascript
const FILES_TO_COPY = ['manifest.json', 'styles.css', 'popup.html', 'popup.js', 'stack-overflow-wordmark.svg'];
```

**变更：**
- 移除硬编码的 'content.js'
- JS 文件由 getJsFiles() 动态管理

### 构建测试结果
执行 `node build.js` 成功拷贝所有模块：

```
Building Silent Reddit extension...

Copied: manifest.json
Copied: styles.css
Copied: popup.html
Copied: popup.js
Copied: stack-overflow-wordmark.svg
Copied: ads-blocker.js
Copied: banner-blocker.js
Copied: constants.js
Copied: content.js
Copied: coordinator.js
Copied: icons-replacer.js
Copied: logo-replacer.js
Copied: media-blocker.js
Copied: mutation-observer.js
Copied: popup.js
Copied: settings-manager.js
Copied directory: icons (7 files)

Build complete: 17 items copied
Output directory: C:\src\silent-reddit-extension\out
```

### 自动化特性
**优点：**
1. **无需手动维护列表**：新增 JS 文件自动包含
2. **安全的排除机制**：自动排除 build.js 和 .backup 文件
3. **Watch 模式支持**：自动监听所有新文件
4. **一致性保证**：build 和 watch 使用相同的扫描逻辑

### 符合 D02 和 D04 讨论
- ✅ **D02**: 采用直接拷贝文件方式（无打包工具）
- ✅ **D02**: build.js 自动扫描根目录下所有 .js 文件
- ✅ **D04**: 排除 .backup 文件

### 扩展性
未来新增模块时：
1. 在根目录创建新的 .js 文件
2. 运行 `node build.js`
3. 自动拷贝到 out/ 目录
4. 无需修改 build.js

**但需要手动更新 manifest.json 的加载顺序**（这是必要的，因为顺序很重要）

---
*创建时间: 2025-10-18*
