# 实现记录 - T13

## 任务信息
- **编号**: T13
- **描述**: 创建 content.js 入口文件：精简为初始化代码，协调各模块完成页面扫描和监听设置

## 实现细节

### 文件结构
使用 IIFE（立即执行函数表达式）包裹所有初始化代码：
```javascript
(async function() {
    // Initialization code
})();
```

**优点：**
- 创建独立作用域
- 支持 async/await
- 立即执行初始化

### 初始化流程

#### 1. 创建 SettingsManager
```javascript
console.log('[SR] Extension initializing...');

const settingsManager = new SilentReddit.SettingsManager();
```

#### 2. 加载设置
```javascript
await settingsManager.load();
console.log('[SR] Settings loaded:', settingsManager.get());
```

**特点：**
- 使用 await 等待设置加载完成
- 记录加载的设置

#### 3. 初始化协调器和观察器
```javascript
SilentReddit.coordinator.init(settingsManager);
SilentReddit.mutationObserver.init(settingsManager);
```

**特点：**
- 依赖注入方式传递 settingsManager
- 初始化所有需要设置的模块

#### 4. 应用初始屏蔽规则
```javascript
if (settingsManager.get().enabled) {
    SilentReddit.coordinator.applyOrRemove();
}
```

**特点：**
- 只在启用状态下应用屏蔽
- 委托 coordinator 处理

#### 5. 处理 Logo 替换
```javascript
const settings = settingsManager.get();
if (settings.replaceLogo) {
    SilentReddit.logoReplacer.replaceAll();
} else {
    SilentReddit.logoReplacer.restoreAll();
}
```

**特点：**
- Logo 替换独立处理（不受 enabled 影响）
- 符合 D01 讨论决策

#### 6. 启动 MutationObserver
```javascript
if (document.body) {
    SilentReddit.mutationObserver.start();
} else {
    document.addEventListener('DOMContentLoaded', () => {
        SilentReddit.mutationObserver.start();
    });
}
```

**特点：**
- 检查 document.body 是否存在
- 如不存在则等待 DOMContentLoaded 事件
- 确保在 document.body 存在时才启动 observer

#### 7. 注册设置变更监听
```javascript
settingsManager.onChange((newSettings, changedSettings) => {
    console.log('[SR] Settings changed, applying updates');
    SilentReddit.coordinator.applyOrRemove();
});
```

**特点：**
- 使用 onChange 注册回调
- 设置变更时自动重新应用屏蔽规则
- 记录设置变更日志

#### 8. 启动设置监听
```javascript
settingsManager.startListening();

console.log('[SR] Initialization complete');
```

**特点：**
- 启动 Chrome storage 监听
- 记录初始化完成日志

### 完整流程图
```
1. 创建 SettingsManager
2. 加载设置（await）
3. 初始化 coordinator 和 mutationObserver
4. 应用初始屏蔽规则（如启用）
5. 处理 Logo 替换
6. 启动 MutationObserver
7. 注册设置变更回调
8. 启动设置监听
9. 初始化完成
```

### 与旧代码对比

**旧代码 (init 函数)：**
- 650 行代码，包含所有业务逻辑
- 函数定义和初始化混杂
- 复杂的 readyState 判断

**新代码：**
- 约 50 行代码，只负责初始化
- 清晰的线性初始化流程
- 业务逻辑全部在各模块中
- 更好的可读性和可维护性

### 依赖的模块（加载顺序）
1. constants.js - 常量定义
2. settings-manager.js - 设置管理
3. ads-blocker.js - 广告屏蔽
4. media-blocker.js - 媒体屏蔽
5. banner-blocker.js - Banner 屏蔽
6. logo-replacer.js - Logo 替换
7. icons-replacer.js - 图标替换
8. coordinator.js - 协调器
9. mutation-observer.js - 观察器
10. content.js - 入口文件

### 错误处理
- 依赖各模块的错误处理
- SettingsManager.load() 内部有 try-catch
- 其他模块采用静默失败策略（符合 D05）

### 日志策略
- 初始化开始：`[SR] Extension initializing...`
- 设置加载完成：`[SR] Settings loaded: {...}`
- 设置变更：`[SR] Settings changed, applying updates`
- 初始化完成：`[SR] Initialization complete`

### 设计原则
- ✅ **职责单一**：只负责初始化和协调
- ✅ **依赖注入**：将 settingsManager 注入到各模块
- ✅ **异步处理**：使用 async/await 处理设置加载
- ✅ **事件驱动**：通过回调响应设置变更
- ✅ **简洁清晰**：代码量大幅减少，逻辑清晰

### manifest.json 中的配置
```json
"run_at": "document_start"
```

**说明：**
- 尽早执行以捕获所有内容
- 代码中已处理 document.body 不存在的情况

---
*创建时间: 2025-10-18*
