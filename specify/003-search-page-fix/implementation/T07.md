# 实现记录 - T07

## 任务信息
- **编号**: T07
- **描述**: 在icons-replacer.js的_replacePostSubredditIcons方法中调用新的_getSubredditNameFromSearchResult方法作为备选方案

## 实现细节

### 修改文件
- `icons-replacer.js`

### 具体变更

修改了`_replacePostSubredditIcons()`方法，添加了备选的社区名提取逻辑：

**修改前：**
```javascript
_replacePostSubredditIcons(targetNode) {
    const selector = SilentReddit.SELECTORS.SUBREDDIT_ICON + ':not([' + SilentReddit.DATA_ATTRS.ICON_REPLACED + '])';
    targetNode.querySelectorAll(selector).forEach(icon => {
        const subredditName = this._getSubredditNameFromIcon(icon);
        if (!subredditName) return;

        const letterAvatar = this._createLetterAvatar(subredditName);
        if (!letterAvatar) return;

        icon.setAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED, 'true');
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC, icon.src);
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE, icon.style.cssText);
        icon.style.setProperty('display', 'none', 'important');
        icon.parentNode?.insertBefore(letterAvatar, icon);
    });
}
```

**修改后：**
```javascript
_replacePostSubredditIcons(targetNode) {
    const selector = SilentReddit.SELECTORS.SUBREDDIT_ICON + ':not([' + SilentReddit.DATA_ATTRS.ICON_REPLACED + '])';
    targetNode.querySelectorAll(selector).forEach(icon => {
        // Try standard method first
        let subredditName = this._getSubredditNameFromIcon(icon);
        
        // If standard method fails, try search result specific method
        if (!subredditName) {
            subredditName = this._getSubredditNameFromSearchResult(icon);
        }
        
        if (!subredditName) return;

        const letterAvatar = this._createLetterAvatar(subredditName);
        if (!letterAvatar) return;

        icon.setAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED, 'true');
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC, icon.src);
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE, icon.style.cssText);
        icon.style.setProperty('display', 'none', 'important');
        icon.parentNode?.insertBefore(letterAvatar, icon);
    });
}
```

### 实现原理

1. **双重提取策略**：
   - **第一步**：使用`_getSubredditNameFromIcon()`标准方法提取
   - **第二步**：如果失败，使用`_getSubredditNameFromSearchResult()`搜索页面专用方法提取
   - 只有两种方法都失败才跳过该图标

2. **优先级设计**：
   - 优先使用标准方法确保普通页面的性能
   - 搜索页面专用方法作为备选，不影响其他页面
   - 搜索页面专用方法内部有`data-testid`容器检查，不会误匹配

3. **向后兼容**：
   - 不改变原有的替换逻辑
   - 只是增加了额外的提取方式
   - 对已经能正常工作的页面没有任何影响

### 影响范围

这个修改增强了社区图标替换的覆盖范围：
- 原有的帖子页面、社区页面等正常工作
- 新增了搜索结果页面社区列表的支持
- 所有使用`.shreddit-subreddit-icon__icon`类的图标都会受益

### 测试验证点

- [ ] page1.html搜索结果社区列表的图标能被正确替换
- [ ] 普通页面的社区图标替换功能不受影响
- [ ] 不会因为搜索页面专用方法导致性能下降
- [ ] 两种提取方法都失败时正确跳过该图标

---
*创建时间: 2025-10-19*
