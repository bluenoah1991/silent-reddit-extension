# 实现记录 - T14

## 任务信息
- **编号**: T14
- **描述**: 修复icons-replacer.js的showAll方法，改为基于USER_AVATAR_IMG和SNOOVATAR选择器动态生成恢复选择器，确保所有被隐藏的头像都能正确恢复显示

## 实现细节

### 问题分析
在切换设置恢复显示原始头像时，部分头像被隐藏而不是显示。原因是 `showAll` 方法中的恢复选择器**不完整**。

**旧的恢复选择器**：
```javascript
const userAvatarSelector = '[slot="commentAvatar"] img[data-sr-icon-replaced], a[href*="/user/"] img[data-sr-icon-replaced]';
const snoovatarSelector = '.snoovatar[data-sr-icon-replaced]';
```

**问题**：
- 缺少 `[data-testid="search-author"] img` 选择器（搜索结果用户列表）
- 缺少 `[data-testid="search-community"] img` 选择器（搜索结果社区列表）
- 缺少 `[data-testid="search-author"] .snoovatar` 选择器
- 导致这些被隐藏的头像无法被恢复选择器找到，最终显示为隐藏状态

### 修改方案

修改 `icons-replacer.js` 的 `showAll` 方法，让恢复选择器**动态生成**，基于 `constants.js` 中定义的完整选择器：

**用户头像图片恢复**：
```javascript
// Restore user avatar images
// Build selector based on USER_AVATAR_IMG definition
const userAvatarSelectors = SilentReddit.SELECTORS.USER_AVATAR_IMG.split(',').map(s => s.trim() + '[' + SilentReddit.DATA_ATTRS.ICON_REPLACED + ']');
const userAvatarSelector = userAvatarSelectors.join(', ');
document.querySelectorAll(userAvatarSelector).forEach(avatar => {
    const originalSrc = avatar.getAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC);
    if (originalSrc) {
        avatar.src = originalSrc;
        avatar.removeAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC);
    }
    avatar.style.cssText = avatar.getAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE) || '';
    avatar.removeAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE);
    avatar.removeAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED);
});
```

**Snoovatar 恢复**：
```javascript
// Restore snoovatar avatars
// Build selector based on SNOOVATAR definition
const snoovatarSelectors = SilentReddit.SELECTORS.SNOOVATAR.split(',').map(s => s.trim() + '[' + SilentReddit.DATA_ATTRS.ICON_REPLACED + ']');
const snoovatarSelector = snoovatarSelectors.join(', ');
document.querySelectorAll(snoovatarSelector).forEach(snoovatar => {
    snoovatar.style.cssText = snoovatar.getAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE) || '';
    snoovatar.removeAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE);
    snoovatar.removeAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED);
});
```

### 技术优势
1. **自动同步**：恢复选择器始终与隐藏选择器保持一致
2. **易于维护**：未来添加新选择器到 `constants.js` 时，恢复逻辑会自动适配
3. **覆盖完整**：确保所有被隐藏的头像都能被找到并恢复
4. **单一来源**：选择器定义集中在 `constants.js`，避免多处维护

### 验证结果
- ✅ 搜索结果页面的用户头像能正确恢复显示
- ✅ 所有类型的头像（评论、用户列表、社区列表）都能正确恢复
- ✅ 切换设置时不再有头像被误隐藏
- ✅ 构建成功，无错误

---
*创建时间: 2025-10-19*
