# 实现记录 - T08

## 任务信息
- **编号**: T08
- **描述**: 扩展constants.js中的SUBREDDIT_ICON选择器，添加`.post-credit-row span[rpl][avatar] img[alt*="r/"]`以覆盖帖子列表中的社区小头像

## 实现细节

### 问题分析

在搜索结果的帖子列表中，发现`post-credit-row`区域的社区头像（24px小头像）没有被替换。经过分析HTML结构，发现：

**未被替换的原因**：
- 外层显示的社区小头像（24px）位于`<span rpl avatar>`容器内
- 这些`<img>`元素**没有**`.shreddit-subreddit-icon__icon`类
- 只有悬浮卡片(hovercard)内的大头像（48px）才有`.shreddit-subreddit-icon__icon`类
- 原选择器`SUBREDDIT_ICON: '.shreddit-subreddit-icon__icon'`无法匹配外层小头像

**DOM结构对比**：
```html
<!-- 外层小头像（24px）- 未被替换 -->
<div class="post-credit-row">
    <span class="inline-flex w-[1.5rem] h-[1.5rem]" rpl="" avatar="">
        <span rpl="" class="inline-block rounded-full ...">
            <img src="..." alt="r/amazonemployees 图标" 
                 class="mb-0 w-full h-full" width="24">
            <!-- 注意：没有 .shreddit-subreddit-icon__icon 类 -->
        </span>
    </span>
</div>

<!-- 悬浮卡片内大头像（48px）- 能被替换 -->
<div slot="content" hidden="">
    <span class="inline-flex w-[3rem] h-[3rem]" rpl="" avatar="">
        <img src="..." alt="r/amazonemployees 图标" 
             class="mb-0 shreddit-subreddit-icon__icon ..." width="48">
        <!-- 有 .shreddit-subreddit-icon__icon 类 -->
    </span>
</div>
```

### 代码修改

**文件**: `constants.js`

**修改前**：
```javascript
// Icon selectors
SUBREDDIT_ICON: '.shreddit-subreddit-icon__icon',
```

**修改后**：
```javascript
// Icon selectors
SUBREDDIT_ICON: '.shreddit-subreddit-icon__icon, .post-credit-row span[rpl][avatar] img[alt*="r/"]',
```

### 选择器说明

新增的选择器：`.post-credit-row span[rpl][avatar] img[alt*="r/"]`

**组成部分**：
- `.post-credit-row` - 限定在帖子credit row容器内，避免误匹配其他区域
- `span[rpl][avatar]` - 头像容器的特征标识属性
- `img[alt*="r/"]` - alt属性包含"r/"的图片，这是社区图标的特征（如"r/amazonemployees 图标"）

**匹配范围**：
- ✅ 帖子列表中的社区小头像（24px）
- ✅ 搜索结果中的帖子社区头像
- ❌ 不会匹配用户头像（alt不包含"r/"）
- ❌ 不会匹配其他类型的图标

### 验证结果

**构建测试**：
```bash
npm run build
# Build complete: 17 items copied
# Output directory: C:\src\silent-reddit-extension\out
```

**浏览器测试**：
- ✅ 帖子列表中的社区头像能正确替换为字母头像
- ✅ 悬浮卡片中的头像也能正常替换
- ✅ 不会误替换其他类型的图标
- ✅ 页面布局和功能正常

### 相关代码

选择器在`icons-replacer.js`中的使用位置：
```javascript
_replacePostSubredditIcons(targetNode) {
    const selector = SilentReddit.SELECTORS.SUBREDDIT_ICON + ':not([' + SilentReddit.DATA_ATTRS.ICON_REPLACED + '])';
    targetNode.querySelectorAll(selector).forEach(icon => {
        // Try standard method first
        let subredditName = this._getSubredditNameFromIcon(icon);

        // If standard method fails, try search result specific method
        if (!subredditName) {
            subredditName = this._getSubredditNameFromSearchResult(icon);
        }

        if (!subredditName) return;

        const letterAvatar = this._createLetterAvatar(subredditName);
        if (!letterAvatar) return;

        // Replace icon with letter avatar
        icon.setAttribute(SilentReddit.DATA_ATTRS.ICON_REPLACED, 'true');
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_SRC, icon.src);
        icon.setAttribute(SilentReddit.DATA_ATTRS.ORIGINAL_STYLE, icon.style.cssText);
        icon.style.setProperty('display', 'none', 'important');
        icon.parentNode?.insertBefore(letterAvatar, icon);
    });
}
```

社区名提取方法（`_getSubredditNameFromIcon`）能正确从：
1. 父链接`a[href^="/r/"]`的href属性提取（优先）
2. img的alt属性提取（备选，使用正则`/r\/([^\s]+)/`）

---
*创建时间: 2025-10-19*
