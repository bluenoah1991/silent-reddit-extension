# 实现记录 - T15

## 任务信息
- **编号**: T15
- **描述**: 实现品牌替换功能，将Reddit logo替换为Stack Overflow logo，添加可切换的设置选项

## 实现细节

### 变更统计
- **文件变更**: 6个文件（5个修改，1个新增）
- **新增行数**: 约80行
- **删除行数**: 约30行（主要为格式调整）

### 主要变更

#### 1. 新增Stack Overflow Logo资源
**文件**: `stack-overflow-wordmark.svg`
- 添加Stack Overflow官方wordmark SVG文件
- 用于替换Reddit页面上的logo显示

#### 2. 扩展配置更新
**文件**: `manifest.json`
- 添加`web_accessible_resources`配置项，允许扩展访问SVG资源文件
- 配置通配符`*.svg`以支持所有SVG文件访问
- 匹配所有页面 `*://*/*` 以确保logo替换在Reddit页面正常工作

#### 3. 构建脚本更新
**文件**: `build.js`
- 将`stack-overflow-wordmark.svg`添加到`FILES_TO_COPY`数组
- 确保构建时将SVG文件复制到输出目录
- 修复代码格式（移除多余空行，统一缩进）

#### 4. 核心功能实现
**文件**: `content.js`

**新增功能**:
- `replaceRedditLogo()` - 替换Reddit logo为Stack Overflow logo
  - 选择器：`a#reddit-logo[href="/"]` 精确定位Reddit首页链接
  - 保存原始内容到`data-originalContent`属性用于恢复
  - 添加`data-silentRedditReplaced`标记防止重复处理
  - 创建`<img>`元素加载Stack Overflow SVG
  - 设置容器和图片的样式确保正确显示（高度32px，flex布局）
  
- `restoreRedditLogo()` - 恢复原始Reddit logo
  - 从`data-originalContent`恢复原始HTML内容
  - 清除所有标记属性和自定义样式

**集成逻辑**:
- 在`DEFAULT_SETTINGS`中添加`replaceLogo: true`
- 在`applyOrRemoveBlocking()`中根据设置应用或恢复logo
- 在`handleMutations()`中持续监听，确保动态加载后logo状态正确
- 在`init()`中初始化时应用logo设置
- 在storage change监听器中添加`replaceLogo`选项

#### 5. 弹出面板UI更新
**文件**: `popup.html`
- 添加第4个设置项："品牌替换"
- 描述文本：将 Reddit 品牌替换为 Stack Overflow
- 绑定toggle元素ID：`replaceLogoToggle`
- 代码格式优化（展开压缩的CSS样式，提升可读性）

#### 6. 弹出面板逻辑更新
**文件**: `popup.js`
- 在`DEFAULT_SETTINGS`中添加`replaceLogo: true`
- 在`toggles`对象中添加`replaceLogo`引用
- 在`updateUI()`中添加`replaceLogo`的禁用状态控制逻辑
- 确保主开关关闭时，logo替换选项也被禁用

### 技术实现亮点

1. **资源访问控制**: 使用Manifest V3的`web_accessible_resources`确保SVG文件安全加载
2. **状态保护**: 通过`data-silentRedditReplaced`标记防止重复处理
3. **可恢复性**: 保存原始内容到`data-originalContent`，支持完整恢复
4. **响应式监听**: 集成到MutationObserver，确保SPA导航后logo状态正确
5. **设置同步**: 通过chrome.storage.sync实现跨设备设置同步
6. **精确选择器**: 使用`a#reddit-logo[href="/"]`精确定位，避免误替换

### 符合项目宪法
- ✅ 代码注释使用英文
- ✅ console消息使用英文（无新增console）
- ✅ 与用户交互使用中文（popup.html中的"品牌替换"说明）

### 测试建议
1. 验证logo替换在Reddit首页正常工作
2. 测试toggle开关的即时切换效果
3. 验证SPA导航（如进入subreddit）后logo状态保持
4. 测试主开关关闭时logo是否正确恢复
5. 验证设置在扩展重载后是否正确持久化

---
*创建时间: 2025-10-17*
