# 实现记录 - T05

## 任务信息
- **编号**: T05
- **描述**: 创建content.js文件，实现MutationObserver监听逻辑，处理动态加载的内容，确保新出现的广告和图片也被屏蔽

## 实现细节

### 创建content.js文件
基于D01讨论结论，实现了使用MutationObserver监听动态内容的JavaScript增强方案。

**核心功能模块：**

#### 1. applyBlockingRules() 函数
应用屏蔽规则到指定的DOM节点：

```javascript
function applyBlockingRules(targetNode = document.body) {
    if (!targetNode) return;

    // Block ad posts (shreddit-ad-post elements)
    const adPosts = targetNode.querySelectorAll ? 
        targetNode.querySelectorAll('shreddit-ad-post') : [];
    adPosts.forEach(ad => {
        ad.style.display = 'none';
    });

    // Block post images (with slot attributes)
    const postImages = targetNode.querySelectorAll ? 
        targetNode.querySelectorAll('article img[slot="thumbnail"], article img[slot="image-gallery"]') : [];
    postImages.forEach(img => {
        img.style.display = 'none';
    });

    // Block other article images (except subreddit icons and user avatars)
    const articleImages = targetNode.querySelectorAll ? 
        targetNode.querySelectorAll('article img') : [];
    articleImages.forEach(img => {
        // Preserve subreddit icons
        if (img.classList.contains('shreddit-subreddit-icon__icon')) {
            return;
        }
        
        // Preserve user avatars
        const parentLink = img.closest('a[href*="/user/"]');
        if (parentLink) {
            return;
        }
        
        // Block everything else
        img.style.display = 'none';
    });

    // Block videos and media players
    const videos = targetNode.querySelectorAll ? 
        targetNode.querySelectorAll('article video, article shreddit-player') : [];
    videos.forEach(video => {
        video.style.display = 'none';
    });

    // Block media containers
    const mediaContainers = targetNode.querySelectorAll ? 
        targetNode.querySelectorAll('article [slot="post-media-container"]') : [];
    mediaContainers.forEach(container => {
        container.style.display = 'none';
    });
}
```

**处理逻辑：**
1. **广告屏蔽**: 查找所有 `shreddit-ad-post` 元素并隐藏
2. **精确图片屏蔽**: 使用slot属性选择器匹配缩略图和图片画廊
3. **后备图片屏蔽**: 查找所有article中的图片，但保留：
   - 带有 `.shreddit-subreddit-icon__icon` 类的社区图标
   - 位于 `a[href*="/user/"]` 链接内的用户头像
4. **视频屏蔽**: 隐藏video和shreddit-player元素
5. **容器屏蔽**: 隐藏媒体容器防止布局问题

#### 2. handleMutations() 函数
处理MutationObserver的回调：

```javascript
function handleMutations(mutations) {
    mutations.forEach(mutation => {
        if (mutation.type === 'childList') {
            // Process newly added nodes
            mutation.addedNodes.forEach(node => {
                // Only process element nodes
                if (node.nodeType === Node.ELEMENT_NODE) {
                    applyBlockingRules(node);
                }
            });
        }
    });
}
```

**处理逻辑：**
- 仅处理 `childList` 类型的变化（子节点添加/删除）
- 遍历所有新添加的节点
- 仅处理元素节点（Element nodes），跳过文本节点等
- 对每个新元素应用屏蔽规则

#### 3. initObserver() 函数
初始化MutationObserver：

```javascript
function initObserver() {
    const observerConfig = {
        childList: true,    // Watch for child node changes
        subtree: true,      // Watch all descendants
        attributes: false   // No need to watch attribute changes
    };

    const observer = new MutationObserver(handleMutations);
    observer.observe(document.body, observerConfig);
    
    console.log('Silent Reddit: MutationObserver initialized');
}
```

**配置说明：**
- `childList: true` - 监听子节点变化（添加/删除）
- `subtree: true` - 监听整个DOM子树的变化
- `attributes: false` - 不需要监听属性变化，减少性能开销

#### 4. init() 和启动逻辑
扩展初始化和启动：

```javascript
function init() {
    console.log('Silent Reddit: Extension loaded');
    
    // Apply rules to existing content
    applyBlockingRules();
    
    // Start observing for dynamic content
    if (document.body) {
        initObserver();
    } else {
        // Wait for body to be available
        document.addEventListener('DOMContentLoaded', initObserver);
    }
}

// Start the extension
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}
```

**启动流程：**
1. 检查document.readyState，根据加载状态选择执行时机
2. 应用屏蔽规则到现有内容
3. 初始化MutationObserver监听后续变化
4. 处理document.body未就绪的边缘情况

### 设计特点

**1. JavaScript增强CSS (符合D01讨论):**
- CSS提供基础屏蔽（快速、声明式）
- JavaScript处理动态内容（灵活、可编程）
- 双重保障确保完全覆盖

**2. 性能优化考虑:**
- 使用querySelectorAll批量查询，减少DOM遍历次数
- 仅监听childList，不监听attributes，降低回调频率
- 检查nodeType，跳过非元素节点
- 使用防御性编程（targetNode.querySelectorAll检查）

**3. 动态内容支持 (符合D01讨论):**
- MutationObserver实时监听DOM变化
- 滚动加载新帖子时自动应用屏蔽规则
- 支持Reddit的单页应用架构

**4. 语言无关策略 (符合D02讨论):**
- 完全基于DOM选择器和结构特征
- 不依赖任何文本内容匹配
- 支持所有语言的Reddit界面

**5. 代码可维护性:**
- 清晰的函数划分（应用规则、处理变化、初始化、启动）
- 详细的英文注释说明每个部分的作用
- 防御性编程处理边缘情况

### 符合宪法约束
- ✅ 所有注释使用英文
- ✅ 所有console消息使用英文
- ✅ 符合D01和D02讨论决策
- ✅ 实现了MutationObserver监听模式

---
*创建时间: 2025-10-17*
