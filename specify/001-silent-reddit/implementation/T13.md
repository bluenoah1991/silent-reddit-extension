# 实现记录 - T13

## 任务信息
- **编号**: T13
- **描述**: 修改图片屏蔽方式为隐藏媒体容器并添加文本占位符，扩展选择器覆盖信息流和打开帖子内的图片，防止重复占位符

## 实现细节

### 问题背景
用户反馈了三个问题需要解决：
1. 希望图片使用占位符而非直接删除
2. 宽图应使用低高度占位符节省空间
3. 打开帖子后内部图片也需要处理

在实现过程中发现：
- 初始尝试用大块div占位符导致样式错乱
- 仅隐藏图片会留下黑色背景容器
- 同一容器内多个图片会创建多个占位符

### 最终解决方案

#### 1. 修改图片处理逻辑（content.js）

**核心改进**：隐藏整个媒体容器而非单独图片

```javascript
// Add a text placeholder next to blocked images
function addImagePlaceholder(img) {
    // Skip if already processed
    if (img.dataset.silentRedditProcessed) {
        return;
    }
    
    // Preserve subreddit icons
    if (img.classList.contains('shreddit-subreddit-icon__icon')) {
        return;
    }
    
    // Preserve user avatars
    const parentLink = img.closest('a[href*="/user/"]');
    if (parentLink) {
        return;
    }
    
    // Preserve small UI icons (likely emoji or decorative icons)
    const computedStyle = window.getComputedStyle(img);
    const displayWidth = parseInt(computedStyle.width) || img.width || 0;
    const displayHeight = parseInt(computedStyle.height) || img.height || 0;
    if (displayWidth < 32 && displayHeight < 32) {
        return;
    }
    
    // Mark image as processed
    img.dataset.silentRedditProcessed = 'true';
    
    // Find the media container
    const mediaContainer = img.closest('[slot="post-media-container"]') || 
                          img.closest('shreddit-player') ||
                          img.closest('[data-click-id="media"]') ||
                          img.closest('figure') ||
                          img.parentElement;
    
    if (mediaContainer) {
        // Check if this container already has a placeholder
        if (mediaContainer.dataset.silentRedditPlaceholder) {
            return;
        }
        
        // Mark container as processed
        mediaContainer.dataset.silentRedditPlaceholder = 'true';
        
        // Hide the entire container
        mediaContainer.style.display = 'none';
        
        // Create text placeholder
        const placeholder = document.createElement('span');
        placeholder.className = 'silent-reddit-text-placeholder';
        placeholder.textContent = '[Image]';
        
        // Insert placeholder after the container
        if (mediaContainer.parentNode) {
            mediaContainer.parentNode.insertBefore(placeholder, mediaContainer.nextSibling);
        }
    }
}
```

**关键点**：
- 使用 `closest()` 向上查找包含图片的容器元素
- 查找顺序：`[slot="post-media-container"]` → `shreddit-player` → `[data-click-id="media"]` → `figure` → 父元素
- 使用 `data-silent-reddit-placeholder` 标记容器，防止重复处理
- 隐藏整个容器后在外部插入文本占位符

**扩展选择器**：

```javascript
const selectors = [
    'article img',           // Images in article elements (feed)
    'shreddit-post img',     // Images in post elements
    '#main-content img',     // Images in main content area
    '[slot="post-media-container"] img',  // Images in media containers
    '.Post img',             // Old Reddit post images
    '[data-testid="post-container"] img'  // Images in post containers
];
```

覆盖了信息流、打开的帖子、主内容区等多个位置。

#### 2. 简化CSS样式（styles.css）

移除复杂的占位符div样式，改为简单文本标签：

```css
/* ===== Image Placeholder Styling ===== */
/* Text placeholder for blocked images */
.silent-reddit-text-placeholder {
    display: inline-block;
    color: #878a8c;
    font-size: 12px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    padding: 4px 8px;
    margin: 4px;
    background-color: #f6f7f8;
    border-radius: 4px;
    border: 1px solid #edeff1;
}
```

添加CSS规则隐藏包含图片的容器：

```css
/* Hide media containers that may have background */
article [slot="post-media-container"],
article figure:has(img),
shreddit-post figure:has(img),
[data-click-id="media"]:has(img) {
    display: none !important;
}
```

### 设计特点

1. **防止重复占位符**：
   - 检查容器是否已标记 `data-silent-reddit-placeholder`
   - 每个容器只创建一个占位符，即使包含多个图片

2. **隐藏容器而非图片**：
   - 避免遗留黑色背景等容器样式
   - 彻底清除图片占用的空间

3. **简洁文本标签**：
   - 使用 `[Image]` 文本提示，不占用太多空间
   - 符合Reddit设计风格，不干扰阅读

4. **全面覆盖**：
   - 信息流中的图片
   - 打开帖子后的图片
   - 评论区可能的图片

5. **保留必要元素**：
   - 用户头像
   - 社区图标
   - 小于32px的UI图标

### 符合宪法约束
- ✅ 所有注释使用英文
- ✅ 所有console消息使用英文
- ✅ 符合D05讨论决策

---
*创建时间: 2025-10-17*
