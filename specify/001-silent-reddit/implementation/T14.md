# 实现记录 - T14

## 任务信息
- **编号**: T14
- **描述**: 添加弹出式设置面板、扩展图标、设置存储功能和实时设置切换能力

## 实现细节

### 概述
本次实现为Silent Reddit扩展添加了完整的用户设置功能，包括弹出式设置界面、扩展图标、设置持久化存储，以及实时设置切换能力。用户现在可以通过扩展图标打开设置面板，自由控制是否启用内容屏蔽、广告屏蔽和媒体屏蔽功能。

### 变更统计
- **修改文件**: 5个（build.js, content.js, manifest.json, styles.css, .gitignore）
- **新增文件**: 10个（7个图标文件 + popup.html + popup.js + popup.css已合并到popup.html）
- **代码行数变化**:
  - build.js: 108行重构（新增目录复制功能）
  - content.js: 277行重构（新增设置管理和动态切换）
  - popup.html: 82行新增
  - popup.js: 70行新增
  - styles.css: 61行优化（简化并美化占位符样式）
  - manifest.json: 21行新增（权限和action配置）

### 核心功能实现

#### 1. 弹出式设置面板 (popup.html + popup.js)

**popup.html设计要点**:
- 紧凑型界面设计（280px宽度），适合浏览器扩展弹出窗口
- 使用内联样式（<style>标签）避免额外CSS文件，简化构建
- 三个独立的开关控件：
  - **启用内容替换**: 主开关，控制整个扩展的启用/禁用
  - **屏蔽广告**: 控制是否隐藏Reddit广告内容
  - **隐藏媒体**: 控制是否隐藏图片和视频
- 中文界面文本，符合宪法语言约束（用户交互使用中文）
- 底部显示实时状态和版本号

**popup.js核心逻辑**:
```javascript
// 默认设置
const DEFAULT_SETTINGS = {
    enabled: true,
    blockAds: true,
    blockMedia: true
};

// 加载设置
async function loadSettings() {
    return await chrome.storage.sync.get(DEFAULT_SETTINGS);
}

// 保存设置
async function saveSettings(settings) {
    await chrome.storage.sync.set(settings);
}

// 设置变更时通知content script
chrome.tabs.sendMessage(tabId, { 
    type: 'SETTINGS_UPDATED', 
    settings 
});
```

**用户体验优化**:
- 开关状态实时反馈，无需刷新页面
- 子选项（blockAds, blockMedia）在主开关关闭时自动禁用
- 状态指示器动态显示"✓ 功能已启用"或"✗ 功能已禁用"

#### 2. 扩展图标系统

**图标规格**:
添加了7个不同尺寸的PNG图标文件，覆盖所有Chrome扩展使用场景：
- 16x16: 浏览器工具栏小图标
- 24x24: 工具栏标准图标（1.5x密度）
- 32x32: 工具栏标准图标（2x密度）
- 64x64: 扩展管理页面图标
- 128x128: Chrome Web Store和安装对话框
- 256x256: 高分辨率显示
- 512x512: 超高分辨率和推广材料

**图标设计**:
- 文件名: `quiet@{size}.png`
- 主题: "quiet"（安静）符合扩展的核心理念
- 样式: 简洁、现代、易识别

**manifest.json配置**:
```json
{
  "icons": {
    "16": "icons/quiet@16.png",
    "24": "icons/quiet@24.png",
    // ... 其他尺寸
  },
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "icons/quiet@16.png",
      // ... 工具栏图标尺寸
    }
  }
}
```

#### 3. 设置存储系统

**Chrome Storage API集成**:
- 使用`chrome.storage.sync` API实现跨设备同步
- 默认设置作为后备值，确保首次加载正常
- 错误处理机制，防止存储失败影响功能

**manifest.json权限**:
```json
{
  "permissions": ["storage"]
}
```

**content.js设置加载**:
```javascript
let currentSettings = { ...DEFAULT_SETTINGS };

async function loadSettings() {
    try {
        currentSettings = await chrome.storage.sync.get(DEFAULT_SETTINGS);
    } catch (error) {
        console.error('Failed to load settings:', error);
    }
}

// 页面加载时初始化
async function init() {
    await loadSettings();
    if (currentSettings.enabled) applyBlockingRules();
    initObserver();
}
```

#### 4. 实时设置切换

**监听机制**:
实现了两种监听方式，确保设置变更立即生效：

**方式1: Message监听（popup直接通知）**:
```javascript
chrome.runtime.onMessage.addListener((message) => {
    if (message.type === 'SETTINGS_UPDATED') {
        currentSettings = message.settings;
        applyOrRemoveBlocking();
    }
});
```

**方式2: Storage监听（跨标签页同步）**:
```javascript
chrome.storage.onChanged.addListener((changes, areaName) => {
    if (areaName !== 'sync') return;
    
    let updated = false;
    ['enabled', 'blockAds', 'blockMedia'].forEach(key => {
        if (changes[key]) {
            currentSettings[key] = changes[key].newValue;
            updated = true;
        }
    });
    
    if (updated) applyOrRemoveBlocking();
});
```

**动态切换逻辑**:
```javascript
function applyOrRemoveBlocking() {
    if (!currentSettings.enabled) {
        removeAllBlocking();  // 完全移除所有屏蔽效果
        return;
    }
    
    // 根据子选项分别处理
    currentSettings.blockAds ? hideAds() : showAds();
    currentSettings.blockMedia ? hideMedia() : showMedia();
}
```

**功能细节**:
- `removeAllBlocking()`: 恢复所有隐藏的元素，移除占位符
- `hideAds()` / `showAds()`: 使用`display: none`切换广告可见性
- `hideMedia()` / `showMedia()`: 切换媒体容器可见性和占位符

#### 5. content.js重构优化

**代码结构改进**:
- 提取常量: `AD_SELECTORS`, `MEDIA_CONTAINER_SELECTOR`
- 功能模块化: 分离广告处理、媒体处理、设置管理
- 防重复处理: 使用`data-silent-reddit-*`属性标记

**媒体保留策略优化**:
新增`shouldPreserveMedia()`函数，统一判断哪些媒体元素应该保留：
```javascript
function shouldPreserveMedia(container) {
    // 已处理的容器
    if (container.dataset.silentRedditPlaceholder) return true;
    
    const img = container.querySelector('img');
    if (img) {
        // 社区图标
        if (img.classList.contains('shreddit-subreddit-icon__icon')) return true;
        // 用户头像
        if (img.closest('a[href*="/user/"]')) return true;
        // 社区状态图标
        if (img.closest('community-status-tooltip, community-status')) return true;
        // 空状态插图
        if (img.closest('comment-forest-empty-state, #low-comments-banner')) return true;
        // 缩略图（帖子列表的小图）
        if (container.closest('[slot="thumbnail"]')) return true;
        // 小型UI图标
        const width = parseInt(window.getComputedStyle(img).width) || 0;
        const height = parseInt(window.getComputedStyle(img).height) || 0;
        if (width < 32 && height < 32) return true;
    }
    
    return false;
}
```

**占位符改进**:
- 区分图片和视频: 使用不同的emoji（🖼️ vs 📹）
- `createPlaceholder(isVideo)`函数统一创建占位符元素
- 自动检测容器内容类型（通过查找`shreddit-embed`等元素）

**性能优化**:
- 提前返回: 功能禁用时立即退出，避免不必要的DOM查询
- 选择器缓存: 使用常量存储复杂选择器
- 批量处理: 使用`querySelectorAll`批量查找和处理元素

#### 6. 构建系统增强 (build.js)

**目录复制功能**:
新增`copyDir()`函数，支持递归复制整个目录：
```javascript
function copyDir(dirName) {
    const sourcePath = path.join(SOURCE_DIR, dirName);
    const destPath = path.join(OUTPUT_DIR, dirName);
    
    ensureDir(destPath);
    const files = fs.readdirSync(sourcePath);
    
    files.forEach(file => {
        const sourceFile = path.join(sourcePath, file);
        const destFile = path.join(destPath, file);
        
        if (fs.statSync(sourceFile).isDirectory()) {
            copyDir(path.join(dirName, file));  // 递归处理子目录
        } else {
            fs.copyFileSync(sourceFile, destFile);
        }
    });
}
```

**配置更新**:
```javascript
const FILES_TO_COPY = [
    'manifest.json', 
    'content.js', 
    'styles.css', 
    'popup.html',   // 新增
    'popup.js'      // 新增
];

const DIRS_TO_COPY = ['icons'];  // 新增
```

**watch模式增强**:
新增对`icons/`目录的监听：
```javascript
DIRS_TO_COPY.forEach(dirName => {
    const dirPath = path.join(SOURCE_DIR, dirName);
    if (fs.existsSync(dirPath)) {
        fs.watch(dirPath, { recursive: true }, (eventType, filename) => {
            if (eventType === 'change' || eventType === 'rename') {
                console.log(`Directory changed: ${dirName}/${filename || ''}`);
                copyDir(dirName);
            }
        });
    }
});
```

**代码简化**:
- 移除冗余注释
- 合并重复逻辑
- 使用三元运算符简化条件判断

#### 7. 样式优化 (styles.css)

**占位符视觉改进**:
从简单文本样式升级为现代化渐变卡片设计：

**之前**:
```css
.silent-reddit-text-placeholder {
    display: inline-block;
    color: #878a8c;
    font-size: 12px;
    padding: 4px 8px;
    background-color: #f6f7f8;
    border-radius: 4px;
}
```

**现在**:
```css
.silent-reddit-text-placeholder {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;           /* 使用emoji，字体更大 */
    padding: 4px 6px;
    margin: 4px 0 8px;
    background: linear-gradient(135deg, #f0f4f8, #e6eef5);  /* 渐变背景 */
    border-radius: 6px;
    border: 1px solid #d3dce6;
    box-shadow: 0 1px 2px #0000000d;
    transition: all .2s;
    cursor: default;
    opacity: .9;
}

.silent-reddit-text-placeholder:hover {
    background: linear-gradient(135deg, #e8f0f8, #dae6f0);
    border-color: #b8c9db;
    box-shadow: 0 2px 3px #00000014;
    opacity: 1;
}
```

**设计改进**:
- 使用flexbox居中emoji图标
- 渐变背景提升视觉层次
- hover效果增加交互反馈
- 阴影和过渡动画提升现代感

**代码清理**:
移除了冗余的CSS注释和多余的选择器，保留核心样式定义。

### 技术亮点

1. **零外部依赖**: popup.html使用内联CSS，避免额外的样式文件
2. **跨设备同步**: 使用`chrome.storage.sync`实现设置云同步
3. **双重监听机制**: Message + Storage监听确保设置变更可靠传递
4. **优雅降级**: 存储失败时使用默认设置，不影响核心功能
5. **性能优化**: 提前返回和选择器缓存减少DOM操作开销
6. **代码简化**: 重构消除冗余，提升可维护性

### 用户体验提升

1. **即时反馈**: 设置变更立即生效，无需刷新页面
2. **状态透明**: 清晰显示当前功能启用状态
3. **细粒度控制**: 分别控制广告和媒体屏蔽
4. **视觉美化**: 占位符采用现代渐变设计
5. **国际化准备**: 中文界面符合目标用户群体

### 验证测试

建议进行以下测试：
1. 测试popup面板开关的实时响应
2. 验证设置跨标签页同步效果
3. 测试功能完全禁用后的恢复效果
4. 检查各尺寸图标在不同场景下的显示
5. 验证占位符在不同主题下的可读性

---
*创建时间: 2025-10-17*
