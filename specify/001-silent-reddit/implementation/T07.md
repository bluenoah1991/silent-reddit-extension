# 实现记录 - T07

## 任务信息
- **编号**: T07
- **描述**: 在package.json中实现watch脚本，监听源文件变化并自动重新构建到out/目录

## 实现细节

### 在build.js中实现watch功能
在T06创建的build.js文件中添加了watch模式，监听文件变化并自动重新构建。

### 核心功能模块

#### 1. watch() 函数
实现文件监听和自动构建：

```javascript
function watch() {
    console.log('Starting watch mode...\n');
    
    // Initial build
    build();
    
    console.log('\nWatching for file changes...');
    console.log('Press Ctrl+C to stop\n');
    
    // Watch each source file
    FILES_TO_COPY.forEach(fileName => {
        const filePath = path.join(SOURCE_DIR, fileName);
        
        if (fs.existsSync(filePath)) {
            fs.watch(filePath, (eventType) => {
                if (eventType === 'change') {
                    console.log(`\nFile changed: ${fileName}`);
                    copyFile(fileName);
                }
            });
        }
    });
}
```

**功能说明：**
- 输出watch模式启动信息
- 执行初始构建（确保out/目录是最新的）
- 提示用户如何停止watch模式
- 遍历所有需要监听的文件
- 使用 `fs.watch()` 监听每个文件的变化
- 仅处理 'change' 事件（文件内容修改）
- 文件变化时自动复制到out/目录

#### 2. 命令行参数解析
根据参数决定执行模式：

```javascript
// Main execution
const args = process.argv.slice(2);

if (args.includes('--watch') || args.includes('-w')) {
    watch();
} else {
    build();
}
```

**功能说明：**
- 解析命令行参数
- 支持 `--watch` 或 `-w` 参数启动watch模式
- 无参数则执行普通构建

### package.json配置

在T02已经配置好的npm scripts中，watch脚本已经指向build.js：

```json
{
  "scripts": {
    "build": "node build.js",
    "watch": "node build.js --watch"
  }
}
```

### 使用方式

#### 启动watch模式：
```bash
npm run watch
```

**预期输出：**
```
> silent-reddit@1.0.0 watch
> node build.js --watch

Starting watch mode...

Building Silent Reddit extension...

Copied: manifest.json
Copied: content.js
Copied: styles.css

Build complete: 3 files copied
Output directory: C:\src\silent-reddit-extension\out

Watching for file changes...
Press Ctrl+C to stop
```

#### 文件变化时的输出：
当修改 `content.js` 文件后：
```
File changed: content.js
Copied: content.js
```

### 设计特点

**1. 自动化开发流程：**
- 文件保存后自动重新构建
- 无需手动执行npm run build
- 提升开发效率

**2. 实时反馈：**
- 清晰输出哪个文件发生了变化
- 立即显示复制结果
- 开发者可以马上在Chrome中刷新扩展

**3. 轻量级实现：**
- 使用Node.js原生 `fs.watch()` API
- 零依赖，无需安装额外的监听工具
- 符合项目"简洁实用"的设计原则

**4. 灵活性：**
- 支持短参数 `-w` 和长参数 `--watch`
- 可以通过Ctrl+C优雅地停止
- 与build命令共享相同的代码逻辑

### 开发工作流

推荐的开发流程（符合D04讨论决策）：

1. **首次部署：**
   ```bash
   npm run build
   ```
   在Chrome浏览器中加载 `out/` 目录

2. **开发阶段：**
   ```bash
   npm run watch
   ```
   在另一个终端窗口保持运行

3. **测试更改：**
   - 编辑源文件（content.js、styles.css等）
   - 保存文件（自动构建到out/）
   - 在Chrome扩展管理页面点击刷新按钮
   - 刷新Reddit页面查看效果

### 技术限制

**无法实现的功能（符合Chrome限制）：**
- ❌ 自动刷新Chrome扩展（需要扩展具有特殊权限）
- ❌ 从CRX文件直接安装（Chrome 33+禁止）

**已实现的功能：**
- ✅ 自动监听文件变化
- ✅ 自动重新构建到out/目录
- ⚠️ 需手动在Chrome中点击刷新（可接受的工作流）

### 符合宪法约束
- ✅ 所有注释使用英文
- ✅ 所有console消息使用英文
- ✅ 符合D04讨论决策（watch模式支持）

---
*创建时间: 2025-10-17*
